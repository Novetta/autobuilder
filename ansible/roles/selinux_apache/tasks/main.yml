---
- name: Install apache
  yum:
    name: httpd
    state: present

- name: Enable httpd service
  systemd:
    name: httpd
    enabled: yes
    state: started

- name: Install selinux tools
  yum:
    name:
      - policycoreutils
    state: present

- name: Install selinux troubleshoot
  yum:
    name:
      - setroubleshoot
    state: present

- name: Make new DocumentRoot directory
  file:
    path: /www
    state: directory
    owner: root
    group: root
    mode: 755

- name: Make new DocumentRoot directory path
  file:
    path: /www/target02
    state: directory
    owner: root
    group: root
    mode: 755

- name: Make new apache logs directory
  file:
    path: /www/logs
    state: directory
    owner: root
    group: root
    mode: 755

- name: Make new apache cache directory
  file:
    path: /www/cache
    state: directory
    owner: root
    group: root
    mode: 755

- name: Make new apache public content directory
  file:
    path: /www/target02/public_html/
    state: directory
    owner: root
    group: root
    mode: 755

- name: Make new apache public content upload directory
  file:
    path: /www/target02/public_html/uploads
    state: directory
    owner: root
    group: root
    mode: 755

- name: Create DocumentRoot file
  file:
    path: /www/target02/index.html
    state: touch

- name: Create WordPress file
  file:
    path: /www/target02/public_html/wp-config.html
    state: touch

- name: Add listen port to httpd.conf
  lineinfile:
    path: /etc/httpd/conf/httpd.conf
    state: present
    line: Listen 8081
    insertafter: Listen 80

- name: Insert ServerName in httpd.conf
  lineinfile:
    path: /etc/httpd/conf/httpd.conf
    state: present
    line: ServerName 192.168.3.102:8081
    insertafter: '^#ServerName www.example.com:80'

- name: Update http port in firewall
  firewalld:
    port: 8081/tcp
    permanent: true
    state: enabled

- name: Reload firewalld
  systemd:
    name: firewalld
    state: reloaded

- name: Update DocumentRoot path in httpd.conf
  lineinfile:
    path: /etc/httpd/conf/httpd.conf
    regexp: 'DocumentRoot "/var/www/html"'
    state: present
    line: DocumentRoot "/www/target02/"

- name: Replace web applicaiton dir path
  lineinfile:
    path: /etc/httpd/conf/httpd.conf
    regexp: '<Directory "/var/www">'
    state: present
    line: <Directory "/www">

- name: Replace web application dir path
  lineinfile:
    path: /etc/httpd/conf/httpd.conf
    regexp: '<Directory "/var/www/html">'
    state: present
    line: <Directory "/www/target02">

#- name: Replace logs dir path
#  lineinfile:
#    path: /etc/httpd/conf/httpd.conf
#    regexp: 'ErrorLog "logs/error_log"'
#    state: present
#    line: ErrorLog "/www/target02/logs/error_log"

#- name: Replace Custom logs dir path
#  lineinfile:
#    path: /etc/httpd/conf/httpd.conf
#    regexp: 'CustomLog "logs/access_log" combined'
#    state: present
#    line: CustomLog "/www/target02/logs/access_log" combined

- name: SElinux allow apache to listen on port 8081
  seport:
    ports: 8081
    proto: tcp
    setype: http_port_t
    state: present  

- name: Add file context for apache DocumentRoot dir
  sefcontext:
    target: "/www/(/.*)?"
    setype: httpd_sys_content_t
    state: present

- name: Add file context for apache logs dir
  sefcontext:
    target: "/www(/.*)?/logs(/.*)?"
    setype: httpd_log_t
    state: present

- name: Add file context for apache cache dir
  sefcontext:
    target: "/www/cache/(/.*)?"
    setype: httpd_cache_t
    state: present

- name: Add file context for apache public upload dir
  sefcontext:
    target: "/www/target02/public_html/uploads(/.*)?"
    setype: httpd_sys_rw_content_t
    state: present

- name: Add file context for apache WordPress file
  sefcontext:
    target: /www/target02/public_html/wp-config.html
    setype: httpd_sys_rw_content_t
    state: present

  notify:
    - semanage restorecon

- name: Restart apache
  systemd:
    name: httpd
    state: restarted
